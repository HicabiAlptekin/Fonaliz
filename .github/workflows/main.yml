name: Fon Analiz Scripti
on:
  push:
    branches:
      - main
  schedule:
    # Her iş günü Türkiye saati ile 11:00 (UTC 08:00)
    - cron: '0 8 * * 1-5'
  workflow_dispatch: # Manuel çalıştırma için

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Depoyu Kopyala
        uses: actions/checkout@v4
        with:
          ref: 'main'

      - name: Python 3.12 Kurulumu
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Gereksinimleri Yükle
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            echo "LOG: requirements.txt bulunuyor, bağımlılıklar yükleniyor..."
            pip install -r requirements.txt
          else
            echo "HATA: requirements.txt bulunamadı!"
            exit 1
          fi

      - name: Analiz Scriptini Çalıştır
        run: |
          echo "LOG: analiz_script.py çalıştırılıyor..."
          python analiz_script.py
          echo "LOG: analiz_script.py tamamlandı."

      - name: Dosya Sistemini Kontrol Et
        if: always()
        run: |
          echo "--- İşlem Sonrası Dosyalar Listeleniyor ---"
          ls -l
          echo "-------------------------------------------"

      - name: Dosyaların Oluştuğunu Kontrol Et
        id: check_files
        if: always()
        run: |
          if ls Hisse_Senedi_Fon_Analizi_*.xlsx >/dev/null 2>&1; then
            echo "LOG: Excel dosyası başarıyla oluşturuldu."
            echo "excel_file_exists=true" >> $GITHUB_OUTPUT
            echo "excel_file=$(ls Hisse_Senedi_Fon_Analizi_*.xlsx)" >> $GITHUB_OUTPUT
          else
            echo "UYARI: Excel dosyası oluşturulamadı. Özet raporu kontrol edin."
            echo "excel_file_exists=false" >> $GITHUB_OUTPUT
          fi
          if [ -f analiz_ozeti.txt ]; then
            echo "LOG: analiz_ozeti.txt bulundu."
            echo "summary_file_exists=true" >> $GITHUB_OUTPUT
          else
            echo "UYARI: analiz_ozeti.txt bulunamadı."
            echo "summary_file_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Özet Raporunu Artifact Olarak Yükle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Analiz_Ozeti
          path: analiz_ozeti.txt
          if-no-files-found: warn

      - name: Sürüm Oluştur ve Raporları Yükle
        if: steps.check_files.outputs.excel_file_exists == 'true' || steps.check_files.outputs.summary_file_exists == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: analiz-${{ github.run_id }}
          name: "Fon Analizi Raporu - ${{ github.run_id }}"
          files: |
            ${{ steps.check_files.outputs.excel_file }}
            analiz_ozeti.txt
          body: |
            ${{ github.workflow }} iş akışının otomatik olarak oluşturduğu fon analizi raporu.
            - Excel dosyası: ${{ steps.check_files.outputs.excel_file_exists == 'true' && steps.check_files.outputs.excel_file || 'Oluşturulmadı' }}
            - Özet raporu: ${{ steps.check_files.outputs.summary_file_exists == 'true' && 'analiz_ozeti.txt' || 'Oluşturulmadı' }}
