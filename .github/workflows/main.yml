name: Günlük Fon Taraması ve Kontrol

on:
  schedule:
    # Türkiye saati ile 10:45 (UTC 07:45) - İş günleri (Pazartesi-Cuma)
    # Bursa, Türkiye UTC+3 olduğundan, 10:45 TRT için 07:45 UTC'dir.
    - cron: '45 7 * * 1-5' # cron formatı "dakika saat gün_ay gün_hafta"

  # Manuel olarak çalıştırma yeteneği sağlar
  workflow_dispatch:

jobs:
  tarama_isi:
    runs-on: ubuntu-latest

    steps:
    - name: Kodu Çek
      uses: actions/checkout@v4

    - name: Python Ortamını Kur
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Bağımlılıkları Yükle
      run: |
        python -m pip install --upgrade pip
        if [ -f gereksinimler.txt ]; then
          pip install -r gereksinimler.txt
        else
          echo "❌ Hata: gereksinimler.txt bulunamadı! Lütfen dosya adını kontrol edin."
          exit 1
        fi

    - name: İlk Tarama Scriptini Çalıştır
      id: primary_scan_run # Bu adıma bir ID veriyoruz
      env:
        GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      run: python tarama_script.py

    - name: Boş Veri Kontrolü ve Yeniden Çalıştırma (Gerekliyse)
      # Sadece önceki adımın (primary_scan_run) 'needs_retry' çıktısı 'true' ise bu adım çalışır
      if: steps.primary_scan_run.outputs.needs_retry == 'true'
      run: |
        echo "❗ 5 veya daha fazla boş fiyat verisi tespit edildi. 20 dakika bekleyip tekrar denenecek."
        sleep 1200 # 20 dakika * 60 saniye = 1200 saniye
        echo "🔄 Yeniden tarama başlatılıyor..."
        # İlk tarama başarılı olsa bile, yeniden tarama adımı çalıştığı için buradaki scriptin tekrar çalışması gerekir.
        # Bu tekrar çalıştırma, aynı Python scriptini tekrar çağırır.
        python tarama_script.py
